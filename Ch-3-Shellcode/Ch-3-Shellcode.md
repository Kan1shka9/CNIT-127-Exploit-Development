#### Ch 3: Shellcode

###### ```exit()```

```c
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat e.c
main()
{
	exit(0);
}
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ gcc -static e.c -o e
e.c:1:1: warning: return type defaults to ‘int’ [-Wimplicit-int]
 main()
 ^~~~
e.c: In function ‘main’:
e.c:3:2: warning: implicit declaration of function ‘exit’ [-Wimplicit-function-declaration]
  exit(0);
  ^~~~
e.c:3:2: warning: incompatible implicit declaration of built-in function ‘exit’
e.c:3:2: note: include ‘<stdlib.h>’ or provide a declaration of ‘exit’
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ ./e
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ gdb ./e -q
Reading symbols from ./e...(no debugging symbols found)...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x080489cc <+0>:		lea    ecx,[esp+0x4]
   0x080489d0 <+4>:		and    esp,0xfffffff0
   0x080489d3 <+7>:		push   DWORD PTR [ecx-0x4]
   0x080489d6 <+10>:	push   ebp
   0x080489d7 <+11>:	mov    ebp,esp
   0x080489d9 <+13>:	push   ecx
   0x080489da <+14>:	sub    esp,0x4
   0x080489dd <+17>:	sub    esp,0xc
   0x080489e0 <+20>:	push   0x0
   0x080489e2 <+22>:	call   0x804e760 <exit>
End of assembler dump.
(gdb) disassemble exit
Dump of assembler code for function exit:
   0x0804e760 <+0>:		sub    esp,0xc
   0x0804e763 <+3>:		push   0x1
   0x0804e765 <+5>:		push   0x1
   0x0804e767 <+7>:		push   0x80ec070
   0x0804e76c <+12>:	push   DWORD PTR [esp+0x1c]
   0x0804e770 <+16>:	call   0x804e640 <__run_exit_handlers>
End of assembler dump.
(gdb) disassemble __run_exit_handlers
Dump of assembler code for function __run_exit_handlers:
   0x0804e640 <+0>:	push   ebp
   0x0804e641 <+1>:	push   edi
   0x0804e642 <+2>:	mov    edx,0x0
   0x0804e647 <+7>:	push   esi
   0x0804e648 <+8>:	push   ebx
   0x0804e649 <+9>:	sub    esp,0xc
   0x0804e64c <+12>:	test   edx,edx
   0x0804e64e <+14>:	mov    ebx,DWORD PTR [esp+0x20]
   0x0804e652 <+18>:	mov    esi,DWORD PTR [esp+0x24]
   0x0804e656 <+22>:	mov    ebp,DWORD PTR [esp+0x28]
   0x0804e65a <+26>:	mov    eax,DWORD PTR [esp+0x2c]
   0x0804e65e <+30>:	je     0x804e669 <__run_exit_handlers+41>
   0x0804e660 <+32>:	test   al,al
   0x0804e662 <+34>:	je     0x804e669 <__run_exit_handlers+41>
   0x0804e664 <+36>:	call   0x0
   0x0804e669 <+41>:	mov    edi,DWORD PTR [esi]
   0x0804e66b <+43>:	test   edi,edi
   0x0804e66d <+45>:	je     0x804e6ae <__run_exit_handlers+110>
   0x0804e66f <+47>:	nop
   0x0804e670 <+48>:	mov    eax,DWORD PTR [edi+0x4]
   0x0804e673 <+51>:	mov    edx,eax
   0x0804e675 <+53>:	shl    edx,0x4
   0x0804e678 <+56>:	test   eax,eax
   0x0804e67a <+58>:	lea    ecx,[edi+edx*1-0x8]
   0x0804e67e <+62>:	je     0x804e6a2 <__run_exit_handlers+98>
   0x0804e680 <+64>:	mov    edx,DWORD PTR [ecx]
   0x0804e682 <+66>:	sub    eax,0x1
   0x0804e685 <+69>:	mov    DWORD PTR [edi+0x4],eax
   0x0804e688 <+72>:	cmp    edx,0x3
   0x0804e68b <+75>:	je     0x804e730 <__run_exit_handlers+240>
   0x0804e691 <+81>:	cmp    edx,0x4
   0x0804e694 <+84>:	je     0x804e708 <__run_exit_handlers+200>
   0x0804e696 <+86>:	cmp    edx,0x2
   0x0804e699 <+89>:	je     0x804e6e0 <__run_exit_handlers+160>
   0x0804e69b <+91>:	sub    ecx,0x10
   0x0804e69e <+94>:	test   eax,eax
   0x0804e6a0 <+96>:	jne    0x804e680 <__run_exit_handlers+64>
   0x0804e6a2 <+98>:	mov    eax,DWORD PTR [edi]
   0x0804e6a4 <+100>:	test   eax,eax
   0x0804e6a6 <+102>:	mov    DWORD PTR [esi],eax
   0x0804e6a8 <+104>:	jne    0x804e748 <__run_exit_handlers+264>
   0x0804e6ae <+110>:	mov    eax,ebp
   0x0804e6b0 <+112>:	test   al,al
   0x0804e6b2 <+114>:	je     0x804e6cf <__run_exit_handlers+143>
   0x0804e6b4 <+116>:	mov    eax,0x80d7574
   0x0804e6b9 <+121>:	cmp    eax,0x80d7578
   0x0804e6be <+126>:	jae    0x804e6cf <__run_exit_handlers+143>
   0x0804e6c0 <+128>:	mov    esi,eax
   0x0804e6c2 <+130>:	call   DWORD PTR [esi]
   0x0804e6c4 <+132>:	add    esi,0x4
   0x0804e6c7 <+135>:	cmp    esi,0x80d7578
   0x0804e6cd <+141>:	jb     0x804e6c2 <__run_exit_handlers+130>
   0x0804e6cf <+143>:	sub    esp,0xc
   0x0804e6d2 <+146>:	push   ebx
   0x0804e6d3 <+147>:	call   0x806d8d1 <_exit>
   0x0804e6d8 <+152>:	nop
---Type <return> to continue, or q <return> to quit---
   0x0804e6d9 <+153>:	lea    esi,[esi+eiz*1+0x0]
   0x0804e6e0 <+160>:	shl    eax,0x4
   0x0804e6e3 <+163>:	sub    esp,0x8
   0x0804e6e6 <+166>:	add    eax,edi
   0x0804e6e8 <+168>:	mov    edx,DWORD PTR [eax+0xc]
   0x0804e6eb <+171>:	push   DWORD PTR [eax+0x10]
   0x0804e6ee <+174>:	push   ebx
   0x0804e6ef <+175>:	ror    edx,0x9
   0x0804e6f2 <+178>:	xor    edx,DWORD PTR gs:0x18
   0x0804e6f9 <+185>:	call   edx
   0x0804e6fb <+187>:	add    esp,0x10
   0x0804e6fe <+190>:	jmp    0x804e670 <__run_exit_handlers+48>
   0x0804e703 <+195>:	nop
   0x0804e704 <+196>:	lea    esi,[esi+eiz*1+0x0]
   0x0804e708 <+200>:	shl    eax,0x4
   0x0804e70b <+203>:	sub    esp,0x8
   0x0804e70e <+206>:	add    eax,edi
   0x0804e710 <+208>:	mov    edx,DWORD PTR [eax+0xc]
   0x0804e713 <+211>:	push   ebx
   0x0804e714 <+212>:	push   DWORD PTR [eax+0x10]
   0x0804e717 <+215>:	ror    edx,0x9
   0x0804e71a <+218>:	xor    edx,DWORD PTR gs:0x18
   0x0804e721 <+225>:	call   edx
   0x0804e723 <+227>:	add    esp,0x10
   0x0804e726 <+230>:	jmp    0x804e670 <__run_exit_handlers+48>
   0x0804e72b <+235>:	nop
   0x0804e72c <+236>:	lea    esi,[esi+eiz*1+0x0]
   0x0804e730 <+240>:	shl    eax,0x4
   0x0804e733 <+243>:	mov    eax,DWORD PTR [edi+eax*1+0xc]
   0x0804e737 <+247>:	ror    eax,0x9
   0x0804e73a <+250>:	xor    eax,DWORD PTR gs:0x18
   0x0804e741 <+257>:	call   eax
   0x0804e743 <+259>:	jmp    0x804e670 <__run_exit_handlers+48>
   0x0804e748 <+264>:	sub    esp,0xc
   0x0804e74b <+267>:	push   edi
   0x0804e74c <+268>:	call   0x805a590 <free>
   0x0804e751 <+273>:	add    esp,0x10
   0x0804e754 <+276>:	jmp    0x804e669 <__run_exit_handlers+41>
End of assembler dump.
(gdb) disassemble _exit
Dump of assembler code for function _exit:
   0x0806d8d1 <+0>:	mov    ebx,DWORD PTR [esp+0x4]
   0x0806d8d5 <+4>:	mov    eax,0xfc
   0x0806d8da <+9>:	call   DWORD PTR ds:0x80ec9f0
   0x0806d8e0 <+15>:	mov    eax,0x1
   0x0806d8e5 <+20>:	int    0x80
   0x0806d8e7 <+22>:	hlt
End of assembler dump.
(gdb)
```

```sh
➜  ~ python
Python 2.7.13 (default, Dec 18 2016, 07:03:39)
[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.42.1)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> 0xfc
252
>>>
```

###### Assembly for ```exit()```

```nasm
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat exit.asm
section .text

	global _start

_start:

	mov ebx,0
	mov eax,1
	int 0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

###### nasm and ld

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ nasm -f elf exit.asm
u32@u32-VirtualBox:~/cnit127/chapter-3$ ld -o exit_shellcode exit.o
u32@u32-VirtualBox:~/cnit127/chapter-3$ ls -l exit_sh*
-rwxrwxr-x 1 u32 u32 488 Aug 31 20:26 exit_shellcode
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ ./exit_shellcode
```

###### objdump

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -d exit_shellcode

exit_shellcode:     file format elf32-i386


Disassembly of section .text:

08048060 <_start>:
 8048060:	bb 00 00 00 00       	mov    $0x0,%ebx
 8048065:	b8 01 00 00 00       	mov    $0x1,%eax
 804806a:	cd 80                	int    $0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -D exit_shellcode -M intel

exit_shellcode:     file format elf32-i386


Disassembly of section .text:

08048060 <_start>:
 8048060:	bb 00 00 00 00       	mov    ebx,0x0
 8048065:	b8 01 00 00 00       	mov    eax,0x1
 804806a:	cd 80                	int    0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

###### C Code to Test Shellcode

```c
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat test_exit.c
char shellcode[] = "\xbb\x00\x00\x00\x00"
		   "\xb8\x01\x00\x00\x00"
		   "\xcd\x80";

int main(int argc, char **argv)
{
	int (*func)();
	func = (int (*)()) shellcode;
	(int)(*func)();
}
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ gcc test_exit.c -o test_exit -z execstack
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ ./test_exit
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

###### strace

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ strace ./test_exit
execve("./test_exit", ["./test_exit"], [/* 21 vars */]) = 0
brk(NULL)                               = 0x8c95000
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7710000
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
fstat64(3, {st_mode=S_IFREG|0644, st_size=95772, ...}) = 0
mmap2(NULL, 95772, PROT_READ, MAP_PRIVATE, 3, 0) = 0xb76f8000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/i386-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\1\1\1\3\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\0\204\1\0004\0\0\0"..., 512) = 512
fstat64(3, {st_mode=S_IFREG|0755, st_size=1802928, ...}) = 0
mmap2(NULL, 1808924, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb753e000
mmap2(0xb76f2000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1b3000) = 0xb76f2000
mmap2(0xb76f5000, 10780, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xb76f5000
close(3)                                = 0
set_thread_area({entry_number:-1, base_addr:0xb77127c0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1}) = 0 (entry_number:6)
mprotect(0xb76f2000, 8192, PROT_READ)   = 0
mprotect(0x8049000, 4096, PROT_READ)    = 0
mprotect(0xb773a000, 4096, PROT_READ)   = 0
munmap(0xb76f8000, 95772)               = 0
exit(0)                                 = ?
+++ exited with 0 +++
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

###### Getting Rid of Nulls

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -d exit_shellcode

exit_shellcode:     file format elf32-i386


Disassembly of section .text:

08048060 <_start>:
 8048060:	bb 00 00 00 00       	mov    $0x0,%ebx
 8048065:	b8 01 00 00 00       	mov    $0x1,%eax
 804806a:	cd 80                	int    $0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```nasm
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat exit.asm
section .text

	global _start

_start:

	mov ebx,0
	mov eax,1
	int 0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```nasm
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat exit2.asm
section .text

	global _start

_start:

	xor ebx, ebx
	mov al,1
	int 0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ nasm -f elf exit2.asm
u32@u32-VirtualBox:~/cnit127/chapter-3$ ld -o exit_Shellcode2 exit2.o
u32@u32-VirtualBox:~/cnit127/chapter-3$ ./exit_Shellcode2
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -d exit_Shellcode2 -M intel

exit_Shellcode2:     file format elf32-i386


Disassembly of section .text:

08048060 <_start>:
 8048060:	31 db                	xor    ebx,ebx
 8048062:	b0 01                	mov    al,0x1
 8048064:	cd 80                	int    0x80
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```c
u32@u32-VirtualBox:~/cnit127/chapter-3$ cat execve.c
#include<unistd.h>
int main()
{
	char *happy[2];
	happy[0] = "/bin/sh";
	happy[1] = NULL;
	execve(happy[0], happy, NULL);
}
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ gcc execve.c -o execve
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ ./execve
$ ps
  PID TTY          TIME CMD
 7530 pts/3    00:00:00 bash
 7959 pts/3    00:00:00 sh
 7960 pts/3    00:00:00 ps
$
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ gcc -static execve.c -o execve
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -D execve -M intel | grep 080489cc -A 35
080489cc <main>:
 80489cc:	8d 4c 24 04          	lea    ecx,[esp+0x4]
 80489d0:	83 e4 f0             	and    esp,0xfffffff0
 80489d3:	ff 71 fc             	push   DWORD PTR [ecx-0x4]
 80489d6:	55                   	push   ebp
 80489d7:	89 e5                	mov    ebp,esp
 80489d9:	51                   	push   ecx
 80489da:	83 ec 14             	sub    esp,0x14
 80489dd:	65 a1 14 00 00 00    	mov    eax,gs:0x14
 80489e3:	89 45 f4             	mov    DWORD PTR [ebp-0xc],eax
 80489e6:	31 c0                	xor    eax,eax
 80489e8:	c7 45 ec c8 cd 0b 08 	mov    DWORD PTR [ebp-0x14],0x80bcdc8
 80489ef:	c7 45 f0 00 00 00 00 	mov    DWORD PTR [ebp-0x10],0x0
 80489f6:	8b 45 ec             	mov    eax,DWORD PTR [ebp-0x14]
 80489f9:	83 ec 04             	sub    esp,0x4
 80489fc:	6a 00                	push   0x0
 80489fe:	8d 55 ec             	lea    edx,[ebp-0x14]
 8048a01:	52                   	push   edx
 8048a02:	50                   	push   eax
 8048a03:	e8 28 4f 02 00       	call   806d930 <__execve>
 8048a08:	83 c4 10             	add    esp,0x10
 8048a0b:	b8 00 00 00 00       	mov    eax,0x0
 8048a10:	8b 4d f4             	mov    ecx,DWORD PTR [ebp-0xc]
 8048a13:	65 33 0d 14 00 00 00 	xor    ecx,DWORD PTR gs:0x14
 8048a1a:	74 05                	je     8048a21 <main+0x55>
 8048a1c:	e8 cf 78 02 00       	call   80702f0 <__stack_chk_fail>
 8048a21:	8b 4d fc             	mov    ecx,DWORD PTR [ebp-0x4]
 8048a24:	c9                   	leave
 8048a25:	8d 61 fc             	lea    esp,[ecx-0x4]
 8048a28:	c3                   	ret
 8048a29:	66 90                	xchg   ax,ax
 8048a2b:	66 90                	xchg   ax,ax
 8048a2d:	66 90                	xchg   ax,ax
 8048a2f:	90                   	nop

08048a30 <generic_start_main>:
u32@u32-VirtualBox:~/cnit127/chapter-3$
```

Pushes ```3``` Arguments

Calls ```__execve```

```
 80489fc:	6a 00                	push   0x0
 80489fe:	8d 55 ec             	lea    edx,[ebp-0x14]
 8048a01:	52                   	push   edx
 8048a02:	50                   	push   eax
 8048a03:	e8 28 4f 02 00       	call   806d930 <__execve>
```

```sh
u32@u32-VirtualBox:~/cnit127/chapter-3$ objdump -D execve -M intel | grep 0806d930 -A 20
0806d930 <__execve>:
 806d930:	53                   	push   ebx
 806d931:	8b 54 24 10          	mov    edx,DWORD PTR [esp+0x10]
 806d935:	8b 4c 24 0c          	mov    ecx,DWORD PTR [esp+0xc]
 806d939:	8b 5c 24 08          	mov    ebx,DWORD PTR [esp+0x8]
 806d93d:	b8 0b 00 00 00       	mov    eax,0xb
 806d942:	ff 15 f0 c9 0e 08    	call   DWORD PTR ds:0x80ec9f0
 806d948:	5b                   	pop    ebx
 806d949:	3d 01 f0 ff ff       	cmp    eax,0xfffff001
 806d94e:	0f 83 9c 3b 00 00    	jae    80714f0 <__syscall_error>
 806d954:	c3                   	ret
 806d955:	66 90                	xchg   ax,ax
 806d957:	66 90                	xchg   ax,ax
 806d959:	66 90                	xchg   ax,ax
 806d95b:	66 90                	xchg   ax,ax
 806d95d:	66 90                	xchg   ax,ax
 806d95f:	90                   	nop

0806d960 <__sysconf_check_spec>:
 806d960:	55                   	push   ebp
 806d961:	89 e5                	mov    ebp,esp
u32@u32-VirtualBox:~/cnit127/chapter-3$
```